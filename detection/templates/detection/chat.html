{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Breast Cancer Awareness Chat</h2>
        </div>
        <div class="card-body">
            <div id="chat-messages" class="mb-3" style="height: 400px; overflow-y: auto; padding: 15px;">
                <div class="text-center text-muted mb-3">
                    <small>Ask questions about breast cancer awareness, symptoms, or treatments</small>
                </div>
            </div>
            <div class="input-group">
                <input type="text" id="question" class="form-control" 
                       placeholder="Type your question and press Enter..."
                       onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()" id="send-btn" class="btn btn-primary">
                    <span id="send-icon">Send</span>
                    <span id="loading-icon" style="display: none;">
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        Processing...
                    </span>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.chat-message {
    margin-bottom: 15px;
    padding: 10px 15px;
    border-radius: 15px;
    max-width: 80%;
}

.user-message {
    background-color: #e3f2fd;
    margin-left: auto;
    border-top-right-radius: 5px;
}

.bot-message {
    background-color: #f5f5f5;
    margin-right: auto;
    border-top-left-radius: 5px;
}

#chat-messages::-webkit-scrollbar {
    width: 5px;
}

#chat-messages::-webkit-scrollbar-track {
    background: #f1f1f1;
}

#chat-messages::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
}

.typing-indicator {
    background-color: #e6e6e6;
    padding: 8px 16px;
    border-radius: 15px;
    display: inline-block;
    margin-bottom: 15px;
}

.typing-animation {
    display: inline-block;
    animation: blink 1s infinite;
}

@keyframes blink {
    50% { opacity: 0; }
}

.bot-message {
    background-color: #f8f9fa;
    border-left: 4px solid #0d6efd;
    margin-right: auto;
    border-top-left-radius: 5px;
    max-width: 80%;
    line-height: 1.5;
}

.user-message {
    background-color: #e3f2fd;
    border-right: 4px solid #0d6efd;
    margin-left: auto;
    border-top-right-radius: 5px;
    max-width: 80%;
}

.bot-thinking {
    display: flex;
    align-items: center;
    gap: 8px;
    background: #f0f2f5;
    padding: 12px 16px;
    border-radius: 15px;
    width: fit-content;
    margin-bottom: 15px;
}

.dot-pulse {
    position: relative;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background-color: #0d6efd;
    animation: pulse 1.5s infinite;
}

.dot-pulse:nth-child(2) {
    animation-delay: 0.2s;
}

.dot-pulse:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes pulse {
    0% {
        transform: scale(0.8);
        opacity: 0.5;
    }
    50% {
        transform: scale(1.2);
        opacity: 1;
    }
    100% {
        transform: scale(0.8);
        opacity: 0.5;
    }
}

.message-enter {
    opacity: 0;
    transform: translateY(20px);
    animation: slideIn 0.3s ease forwards;
}

@keyframes slideIn {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<script>
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// Update the addMessage function to include animation
function addMessage(content, isUser) {
    const messages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${isUser ? 'user-message' : 'bot-message'} message-enter`;
    messageDiv.innerHTML = content;
    messages.appendChild(messageDiv);
    messages.scrollTop = messages.scrollHeight;
}

function setLoading(loading) {
    const sendIcon = document.getElementById('send-icon');
    const loadingIcon = document.getElementById('loading-icon');
    const sendBtn = document.getElementById('send-btn');
    const questionInput = document.getElementById('question');
    
    sendIcon.style.display = loading ? 'none' : 'inline';
    loadingIcon.style.display = loading ? 'inline' : 'none';
    sendBtn.disabled = loading;
    questionInput.disabled = loading;
}

// Update the addTypingIndicator function
function addTypingIndicator() {
    const messages = document.getElementById('chat-messages');
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'bot-thinking';
    thinkingDiv.id = 'typing-indicator';
    
    // Create dots
    for (let i = 0; i < 3; i++) {
        const dot = document.createElement('div');
        dot.className = 'dot-pulse';
        thinkingDiv.appendChild(dot);
    }
    
    messages.appendChild(thinkingDiv);
    messages.scrollTop = messages.scrollHeight;
}

function removeTypingIndicator() {
    const typingDiv = document.getElementById('typing-indicator');
    if (typingDiv) {
        typingDiv.remove();
    }
}

function sendMessage() {
    const questionInput = document.getElementById('question');
    const question = questionInput.value.trim();
    
    if (!question) return;
    
    addMessage(`<strong>You:</strong> ${question}`, true);
    setLoading(true);
    addTypingIndicator();
    
    fetch('/chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: `question=${encodeURIComponent(question)}`
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        addMessage(`<strong>Bot:</strong> ${data.response}`, false);
        questionInput.value = '';
    })
    .catch(error => {
        removeTypingIndicator();
        addMessage(`<strong>Error:</strong> Failed to get response. Please try again.`, false);
    })
    .finally(() => {
        setLoading(false);
    });
}

// Add initial greeting
document.addEventListener('DOMContentLoaded', function() {
    addMessage("<strong>Bot:</strong> Hello! I'm here to help answer your questions about breast cancer. How can I assist you today?", false);
});
</script>
{% endblock %}